# 架构设计：分层代理系统（Hierarchical Agent System）

**版本**: 2.0
**状态**: 已确认
**日期**: 2025-06-24

## 1. 核心思想：对话式委派模型 (Conversational Delegation Model)

为了提升系统的专业性和能力上限，我们将现有的单一 Agent 模型升级为由一个“大脑”统一协调的、多个“专家”协作的分层代理系统。

其核心思想是：**大脑 (Orchestrator) 负责主持整场对话，它决定在哪个阶段，将对话的控制权（“话筒”）交给哪个专家 Agent。专家在拿到“话筒”后，可以和用户进行多轮对话来澄清需求，直到完成自己的子任务，然后将成果和控制权交还给大脑。**

## 2. Agent 角色定义

### 2.1. Orchestrator Agent (大脑 / 主持人)

-   **职责**:
    1.  **理解与路由**: 作为系统唯一入口，分析用户意图，决定委派给哪个专家。
    2.  **移交控制权**: 暂停自身活动，将对话控制权完全交给指定的专家 Agent。
    3.  **等待与接收**: 等待专家 Agent 主动返回成果摘要。
    4.  **主持与总结**: 接收成果后，根据全局任务目标，决定继续委派给下一个专家，或进行最终总结并回复用户。

### 2.2. Specialist Agent (专家 / 临时主角)

-   **职责**:
    1.  **接收任务**: 从大脑处接收初始任务指令。
    2.  **独立对话**: 拥有独立的对话循环。若信息不足，可直接向用户提问以收集完成任务所需的全部信息。
    3.  **执行工具**: 在信息充足后，调用自身的专业工具（如 API 查询）来完成任务。
    4.  **归还控制权**: 任务完成后，生成结果摘要，并连同对话控制权一起交还给大脑。

## 3. 关键技术实现

### 3.1. 委派机制：LangGraph 条件路由 (Conditional Routing)

我们采用 **LangGraph** 的图结构（Graph）和条件边（Conditional Edges）作为 Agent 之间委派和控制权转移的核心机制。

-   **实现**: 整个分层代理系统被构建为一个状态图（Stateful Graph）。`Orchestrator` (大脑) 是图的入口和中心节点。每个 `Specialist` (专家) 都是图中的一个独立节点。
-   **流程**:
    1.  `Orchestrator` 接收用户请求后，通过其 LLM 的工具调用（Tool Calls）能力，决定是否需要委派给某个专家。
    2.  如果 `Orchestrator` 的输出中包含了指向特定专家的工具调用（例如，`delegate_to_transportation_agent`），图的条件路由逻辑会捕获这个信号。
    3.  控制权通过一条条件边（Conditional Edge）从 `Orchestrator` 节点转移到对应的 `Specialist` 节点（例如，`transportation_agent` 节点）。
-   **控制权循环与交还**:
    -   在 `Specialist` 节点内部，它通过更新 `AgentState` 中的 `next` 字段来决定是继续执行自己的循环（例如，向用户提问、调用工具）还是完成任务。
    -   当 `Specialist` 完成任务后，它会将 `next` 字段设置为空或指向 `Orchestrator`，从而通过图的路由将控制权交还给大脑，并附带上任务成果。

### 3.2. 指令优化：Prompt Engineering

为了让专家能更好地理解任务，大脑将在委派前对指令进行“精炼”和“增强”。

-   **实现**: 通过精心设计大脑的 **System Prompt**，要求它在调用专家工具前，必须结合完整的对话历史和上下文，将用户的原始请求重写为一个清晰、具体的任务描述。
-   **示例**: 用户的模糊请求“订票去北京”，将被大脑优化为具体的指令：“用户希望查询明天从上海出发前往北京的交通票务信息。请与用户确认具体的交通方式和时间偏好，并完成查询。”
